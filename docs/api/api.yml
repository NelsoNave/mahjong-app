openapi: "3.0.3"

info:
  title: "JongReki API"
  version: "1.0.0"
  description: |
    Version Strategy:
    - Major version changes (/v1 -> /v2): Breaking changes
    - Minor version changes: Backward compatible additions
    - Current stable version: v1

servers:
  - url: "http://localhost:3000/api/v1"
    description: "development server"
  - url: "https://[render.api.url]/v1"
    description: "production server"

components:
  schemas:
    Friend:
      type: object
      properties:
        userId: 
          type: integer
        friendId:
          type: integer
        userName:
          type: string
          example: "りさ"
        image:
          type: string
          example: "https://example.com/image-01.png"
    Error:
      type: object
      properties:
        status:
          type: string
          enum: [BAD_REQUEST, UNAUTHORIZED, FORBIDDEN, NOT_FOUND, INTERNAL_ERROR]
        message:
          type: string
        details:
          type: object
          additionalProperties: true
        requestId:
          type: string
          description: "デバッグ用のリクエスト識別子"
    Game:
      type: object
      properties:
        id:
          type: integer
        gameType:
          type: string
          enum: [FREE, SET]
        numberOfPlayers:
          type: integer
          enum: [3, 4]
        playedAt:
          type: string
          format: date
        rate:
          type: integer
        chipRate:
          type: integer
        fee:
          type: integer
        createdBy:
          type: object
          properties:
            userId:
              type: integer
            name:
              type: string
        chipResults:
          type: array
          items:
            type: object
            properties:
              userId:
                type: integer
              name:
                type: string
              chipChange:
                type: integer
        rounds:
          type: array
          items:
            type: object
            properties:
              id:
                type: integer
              roundNumber:
                type: integer
              results:
                type: array
                items:
                  type: object
                  properties:
                    userId:
                      type: integer
                    name:
                      type: string
                    scoreChange:
                      type: integer
                    rank:
                      type: integer
                    position:
                      type: integer

  responses:
    BadRequest:
      description: "Bad Request"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            status: "BAD_REQUEST"
            message: "フレンドIDは正の整数を入力してください"
            details:
              field: "friends_id"
              reason: "invalid_format"
              value: "-1"
            requestId: "req_123"
    Unauthorized:
      description: "Unauthorized"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            status: "UNAUTHORIZED"
            message: "認証が必要です"
            details:
              reason: "token_expired"
              scope: "friends:read"
            requestId: "req_456"
    Forbidden:
      description: "Forbidden"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            status: "FORBIDDEN"
            message: "アクセス権限がありません"
            details:
              reason: "insufficient_permissions"
              scope: "friends:write"
            requestId: "req_789"
    NotFound:
      description: "Not Found"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            status: "NOT_FOUND"
            message: "コンテンツが見つかりません"
            details:
              reason: "resource_not_found"
              resource: "friends"
            requestId: "req_101"
    InternalError:
      description: "Internal Server Error"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            status: "INTERNAL_ERROR"
            message: "予期しないエラーが発生しました"
            details:
              reason: "internal_server_error"
            requestId: "req_102"

paths:
  "/friends":
    get:
      summary: "Get all friends"
      description: "Get data from the friends table including all status."
      tags:
        - friends
      responses:
        "200":
          description: "Successfully get all friends"
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    "pending":
                      type: array
                      items:
                        $ref: "#/components/schemas/Friend"
                    "accept":
                      type: array
                      items:
                        $ref: "#/components/schemas/Friend"
                    "reject":
                      type: array
                      items:
                        $ref: "#/components/schemas/Friend"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"
  "/friends/{id}":
    get:
      summary: "Get friend by id"
      description: "Get data from the friends table by friend_id."
      tags:
        - friends
      parameters:
        - name: id
          in: path
          required: true
          description: "friend_id"
          schema: 
            type: integer
      responses:
        "200":
          description: "Successfully get a friend"
          content:
            application/json:
              schema:
                type: object
                properties:
                  friendId:
                    type: integer
                  userName:
                    type: string
                    example: "りさ"
                  image:
                    type: string
                    example: "https://example.com/image-01.png"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"
    post:
      summary: "Send a friend request"
      description: "Insert data into the friends table."
      tags:
        - friends
      parameters:
        - name: id
          in: path
          required: true
          description: "friendId"
          schema:
            type: integer
      responses:
        "201":
          description: "Successfully sent a friend request"
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "友達申請を送りました"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"
    patch:
      summary: "Approve or reject friend request"
      description: "Update friend status in the friends table"
      tags:
        - friends
      parameters:
        - name: Id
          in: path
          required: true
          description: "friend_id"
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                  enum: [accept, reject]
      responses:
        "200":
          description: "Successfully update a friend's status"
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "友達のステータスを更新しました"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"
    delete:
      summary: "Delete a friend"
      description: "Delete a friend from the friends table(physical deletion)."
      tags:
        - friends
      parameters:
        - name: Id
          in: path
          required: true
          description: "friend_id"
          schema:
            type: integer
      responses:
        "204":
          description: "Successfully delete a friend"
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "友達を削除しました"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"
  "/me":
    get:
      summary: "Get user information"
      description: "Returns information about the logged-in user."
      tags:
        - user
      responses:
        "200":
          description: "Successfully get a user"
          content:
            application/json:
              schema:
                type: object
                properties:
                  userId: 
                    type: integer
                  userName:
                    type: string
                  email:
                    type: string
                    example: "example@gmail.com"
                  language:
                    type: string
                    example: "日本語"
                  image:
                    type: string
                    example: "https://example.com/image-01.png"
                  backgroundImage:
                    type: string
                    example: "https://example.com/image-01.png"
                  subscriptionPlanId:
                    type: integer
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"
    patch:
      summary: "Update user information"
      description: "Update user information for the logged-in user."
      tags:
        - user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                userName:
                  type: string
                  example: "りさ"
                language:
                  type: string
                  example: "English"
                image: 
                  type: string
                  example: "https://example.com/image-01.png"
                backgroundImage:
                  type: string
                  example: "https://example.com/image-01.png"
                subscriptionPlanId:
                  type: integer
      responses:
        "200":
          description: "Successfully update user's information."
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "アカウントを更新しました"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"
    delete:
      summary: "Delete user account"
      description: "Delete a user from the users table"
      tags:
        - user
      responses:
        "200":
          description: "Successfully delete a user"
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "アカウントを削除しました"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"
  "/games":
    get:
      summary: "Get games by year"
      description: "Get games by year"
      tags:
        - games
      parameters:
        - name: year
          in: query
          required: true
          description: "Filter games by year (YYYY)"
          schema:
            type: string
      responses:
        "200":
          description: "Successfully retrieved games"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Game"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"
    
    post:
      summary: "Create a new game with complete results"
      description: "Create a new game session including rounds and chip results"
      tags:
        - games
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - gameType
                - numberOfPlayers
                - rate
                - chipRate
                - fee
                - rounds
                - chipResults
              properties:
                gameType:
                  type: string
                  enum: [FREE, SET]
                numberOfPlayers:
                  type: integer
                  enum: [3, 4]
                rate:
                  type: integer
                chipRate:
                  type: integer
                fee:
                  type: integer
                rounds:
                  type: array
                  items:
                    type: object
                    required:
                      - roundNumber
                      - results
                    properties:
                      roundNumber:
                        type: integer
                      results:
                        type: array
                        items:
                          type: object
                          required:
                            - userId
                            - scoreChange
                            - rank
                            - position
                          properties:
                            userId:
                              type: integer
                            scoreChange:
                              type: integer
                            rank:
                              type: integer
                            position:
                              type: integer
                chipResults:
                  type: array
                  items:
                    type: object
                    required:
                      - userId
                      - chipChange
                    properties:
                      userId:
                        type: integer
                      chipChange:
                        type: integer
      responses:
        "201":
          description: "Successfully created a game with all results"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Game"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  "/games/stats":
    get:
      summary: "Get game statistics"
      description: "Get aggregated statistics for the logged-in user. If month parameter is not provided, returns all-time statistics."
      tags:
        - games
      parameters:
        - name: yearMonth
          in: query
          required: false
          description: "Filter stats by month (YYYY-MM format, e.g. 2024-12)"
          schema:
            type: string
            pattern: '^\d{4}-\d{2}$'
            example: "2024-12"
      responses:
        "200":
          description: "Successfully retrieved game statistics"
          content:
            application/json:
              schema:
                type: object
                properties:
                  threePlayerGameStats:
                    type: object
                    properties:
                      count:
                        type: integer
                        description: "4人麻雀の回数"
                      percentage:
                        type: number
                        format: float
                        description: "4人麻雀の割合"
                      rankStats:
                        type: object
                        properties:
                          "1":
                            type: object
                            properties:
                              count:
                                type: integer
                                description: "1着回数"
                              percentage:
                                type: number
                                format: float
                                description: "1着率"
                          "2":
                            type: object
                            properties:
                              count:
                                type: integer
                                description: "2着回数"
                              percentage:
                                type: number
                                format: float
                                description: "2着率"
                          "3":
                            type: object
                            properties:
                              count:
                                type: integer
                                description: "3着回数"
                              percentage:
                                type: number
                                format: float
                                description: "3着率"
                          "4":
                            type: object
                            properties:
                              count:
                                type: integer
                                description: "4着回数"
                              percentage:
                                type: number
                                format: float
                                description: "4着率"
                          performance:
                            type: object
                            properties:
                              winRate:
                                type: number
                                format: float
                                description: "連対率"
                              averageRank:
                                type: number
                                format: float
                                description: "平均着順"
                              totalChips:
                                type: integer
                                description: "総チップ数"
                              totalPoints:
                                type: integer
                                description: "総得点"
                          financialSummary:
                            type: object
                            properties:
                              income:
                                type: integer
                                description: "収入"
                              expense:
                                type: integer
                                description: "支出"
                              total:
                                type: integer
                                description: "収支"
                              breakdown:
                                type: object
                                properties:
                                  gameFee:
                                    type: object
                                    properties:
                                      income:
                                        type: integer
                                        description: "ゲーム代収入"
                                      expense:
                                        type: integer
                                        description: "ゲーム代支出"
                          dailyStats:
                            type: array
                            items:
                              type: object
                              properties:
                                date:
                                  type: string
                                  format: date
                                income:
                                  type: integer
                                  description: "その日の収入"
                                expense:
                                  type: integer
                                  description: "その日の支出"
                      THREE:
                        type: object
                        properties:
                          count:
                            type: integer
                            description: "3人麻雀の回数"
                          percentage:
                            type: number
                            format: float
                            description: "3人麻雀の割合"
                          rankStats:
                            type: object
                            properties:
                              "1":
                                type: object
                                properties:
                                  count:
                                    type: integer
                                    description: "1着回数"
                                  percentage:
                                    type: number
                                    format: float
                                    description: "1着率"
                              "2":
                                type: object
                                properties:
                                  count:
                                    type: integer
                                    description: "2着回数"
                                  percentage:
                                    type: number
                                    format: float
                                    description: "2着率"
                              "3":
                                type: object
                                properties:
                                  count:
                                    type: integer
                                    description: "3着回数"
                                  percentage:
                                    type: number
                                    format: float
                                    description: "3着率"
                          performance:
                            type: object
                            properties:
                              winRate:
                                type: number
                                format: float
                                description: "連対率"
                              averageRank:
                                type: number
                                format: float
                                description: "平均着順"
                              totalChips:
                                type: integer
                                description: "総チップ数"
                              totalPoints:
                                type: integer
                                description: "総得点"
                          financialSummary:
                            type: object
                            properties:
                              income:
                                type: integer
                                description: "収入"
                              expense:
                                type: integer
                                description: "支出"
                              total:
                                type: integer
                                description: "収支"
                              breakdown:
                                type: object
                                properties:
                                  gameFee:
                                    type: object
                                    properties:
                                      income:
                                        type: integer
                                        description: "ゲーム代収入"
                                      expense:
                                        type: integer
                                        description: "ゲーム代支出"
                          dailyStats:
                            type: array
                            items:
                              type: object
                              properties:
                                date:
                                  type: string
                                  format: date
                                income:
                                  type: integer
                                  description: "その日の収入"
                                expense:
                                  type: integer
                                  description: "その日の支出"
                      FREE:
                        type: object
                        properties:
                          count:
                            type: integer
                            description: "フリー麻雀の回数"
                          percentage:
                            type: number
                            format: float
                            description: "フリー麻雀の割合"
                          rankStats:
                            type: object
                            properties:
                              "1":
                                type: object
                                properties:
                                  count:
                                    type: integer
                                    description: "1着回数"
                                  percentage:
                                    type: number
                                    format: float
                                    description: "1着率"
                              "2":
                                type: object
                                properties:
                                  count:
                                    type: integer
                                    description: "2着回数"
                                  percentage:
                                    type: number
                                    format: float
                                    description: "2着率"
                              "3":
                                type: object
                                properties:
                                  count:
                                    type: integer
                                    description: "3着回数"
                                  percentage:
                                    type: number
                                    format: float
                                    description: "3着率"
                              "4":
                                type: object
                                properties:
                                  count:
                                    type: integer
                                    description: "4着回数"
                                  percentage:
                                    type: number
                                    format: float
                                    description: "4着率"
                          performance:
                            type: object
                            properties:
                              winRate:
                                type: number
                                format: float
                                description: "連対率"
                              averageRank:
                                type: number
                                format: float
                                description: "平均着順"
                              totalChips:
                                type: integer
                                description: "総チップ数"
                              totalPoints:
                                type: integer
                                description: "総得点"
                          financialSummary:
                            type: object
                            properties:
                              income:
                                type: integer
                                description: "収入"
                              expense:
                                type: integer
                                description: "支出"
                              total:
                                type: integer
                                description: "収支"
                              breakdown:
                                type: object
                                properties:
                                  gameFee:
                                    type: object
                                    properties:
                                      income:
                                        type: integer
                                        description: "ゲーム代収入"
                                      expense:
                                        type: integer
                                        description: "ゲーム代支出"
                          dailyStats:
                            type: array
                            items:
                              type: object
                              properties:
                                date:
                                  type: string
                                  format: date
                                income:
                                  type: integer
                                  description: "その日の収入"
                                expense:
                                  type: integer
                                  description: "その日の支出"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  "/games/{id}":
    get:
      summary: "Get game by ID"
      description: "Get detailed information about a specific game"
      tags:
        - games
      parameters:
        - name: id
          in: path
          required: true
          description: "Game ID"
          schema:
            type: integer
      responses:
        "200":
          description: "Successfully retrieved game"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Game"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  